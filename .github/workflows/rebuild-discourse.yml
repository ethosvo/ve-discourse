name: Rebuild Discourse on app.yml change

on:
  push:
    paths:
      - 'containers/app.yml'
  workflow_dispatch:

jobs:
  rebuild-discourse:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      DISCOURSE_SMTP_ADDRESS: ${{ secrets.DISCOURSE_SMTP_ADDRESS }}
      DISCOURSE_SMTP_PORT: ${{ secrets.DISCOURSE_SMTP_PORT }}
      DISCOURSE_SMTP_USER_NAME: ${{ secrets.DISCOURSE_SMTP_USER_NAME }}
      DISCOURSE_SMTP_PASSWORD: ${{ secrets.DISCOURSE_SMTP_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LIGHTSAIL_SSH_KEY }}

      - name: Rebuild Discourse remotely (keepalive + secret substitution)
        shell: bash
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=120 \
              ubuntu@${{ secrets.LIGHTSAIL_HOST }} bash -se <<EOF
          set -e

          # Export secrets into remote shell
          export DISCOURSE_SMTP_ADDRESS="${DISCOURSE_SMTP_ADDRESS}"
          export DISCOURSE_SMTP_PORT="${DISCOURSE_SMTP_PORT}"
          export DISCOURSE_SMTP_USER_NAME="${DISCOURSE_SMTP_USER_NAME}"
          export DISCOURSE_SMTP_PASSWORD="${DISCOURSE_SMTP_PASSWORD}"

          echo "üîÑ Pulling latest ve-discourse repo..."
          sudo rm -rf /mnt/efs/docker-files/ve-discourse
          git clone https://github.com/ethosvo/ve-discourse.git /mnt/efs/docker-files/ve-discourse

          echo "üìã Preparing app.yml with SMTP secrets..."
          cd /mnt/efs/docker-files/ve-discourse/containers
          cp app.yml /tmp/app_resolved.yml

          sudo sed -i "s|SMTP_ADDRESS_PLACEHOLDER|${DISCOURSE_SMTP_ADDRESS}|g" /tmp/app_resolved.yml
          sudo sed -i "s|SMTP_PORT_PLACEHOLDER|${DISCOURSE_SMTP_PORT}|g" /tmp/app_resolved.yml
          sudo sed -i "s|SMTP_USER_NAME_PLACEHOLDER|${DISCOURSE_SMTP_USER_NAME}|g" /tmp/app_resolved.yml
          sudo sed -i "s|SMTP_PASSWORD_PLACEHOLDER|${DISCOURSE_SMTP_PASSWORD}|g" /tmp/app_resolved.yml

          echo "‚úÖ SMTP secrets inserted successfully"

          echo "üßπ Cleaning up old containers and Redis..."
          sudo docker ps -aq --filter "name=app" | xargs -r sudo docker stop
          sudo pkill -f redis-server || true

          echo "üìã Deploying resolved app.yml..."
          sudo cp /tmp/app_resolved.yml /mnt/efs/docker-files/discourse/containers/app.yml
          sudo shred -u /tmp/app_resolved.yml

          echo "üöÄ Rebuilding Discourse (this may take 30‚Äì40 min)..."
          cd /mnt/efs/docker-files/discourse
          sudo ./launcher rebuild app | tee /tmp/discourse-rebuild.log

          echo "üü¢ Starting Discourse container..."
          sudo ./launcher start app

          echo "‚è± Waiting for Discourse to respond..."
          for i in {1..60}; do
            if curl -fsS http://localhost:80 >/dev/null 2>&1; then
              echo "‚úÖ Discourse is up and responding."
              break
            fi
            echo "‚è≥ Waiting for container (attempt ${i}/60)..."
            sleep 10
          done

          echo "üßπ Cleaning temporary logs..."
          sudo rm -f /tmp/discourse-rebuild.log

          echo "‚úÖ Rebuild complete and secrets securely cleaned up!"
          EOF
