## Discourse all-in-one container (EthosVO Commons)
## Validated for Cloudflare → Traefik → HTTPS Discourse chain
## 2025-10-31

templates:
  - "templates/postgres.template.yml"
  - "templates/redis.template.yml"
  - "templates/web.template.yml"
  #- "templates/web.ssl.template.yml"           # traefik handles SSL
  #- "templates/web.letsencrypt.ssl.template.yml"

## internal HTTP only; Traefik terminates at 443
expose:
  - "80"

## ensure the container joins the Traefik public network
docker_args:
  - "--network=ve-infra_public"

params:
  db_default_text_search_config: "pg_catalog.english"
  db_shared_buffers: "256MB"

env:
  LANG: en_US.UTF-8
  LC_ALL: en_US.UTF-8
  LANGUAGE: en_US.UTF-8

  ## ───── Core site config ─────
  DISCOURSE_HOSTNAME: commons.ethosvo.org
  DISCOURSE_DEVELOPER_EMAILS: 'commons@ethosvo.org'
  DISCOURSE_FORCE_HTTPS: true                  # tell Discourse to use HTTPS
  DISCOURSE_USE_X_FORWARDED_PROTO: true        # respect proxy scheme headers
  DISCOURSE_TRUSTED_PROXIES: 172.18.0.0/16     # trust Traefik network

  ## ───── SMTP mail settings ─────
  DISCOURSE_SMTP_ADDRESS: SMTP_ADDRESS_PLACEHOLDER
  DISCOURSE_SMTP_PORT: SMTP_PORT_PLACEHOLDER
  DISCOURSE_SMTP_USER_NAME: SMTP_USER_NAME_PLACEHOLDER
  DISCOURSE_SMTP_PASSWORD: SMTP_PASSWORD_PLACEHOLDER
  DISCOURSE_SMTP_DOMAIN: commons.ethosvo.org
  DISCOURSE_NOTIFICATION_EMAIL: noreply@ethosvo.org

  ## ───── Let’s Encrypt (for Discourse internal TLS) ─────
  LETSENCRYPT_ACCOUNT_EMAIL: robert.pye@ethosvo.org

volumes:
  - volume:
      host: /var/discourse/shared/standalone
      guest: /shared
  - volume:
      host: /var/discourse/shared/standalone/log/var-log
      guest: /var/log

## ───── Hook plugins ─────
hooks:
  after_code:
    - exec:
        cd: $home/plugins
        cmd:
          - git clone https://github.com/discourse/docker_manager.git
          # No Google OAuth plugin (now built-in)

## ───── Traefik routing labels ─────
labels:
  traefik.enable: "true"

  ## Router: HTTPS only, via Let's Encrypt from Traefik
  traefik.http.routers.discourse.rule: "Host(`commons.ethosvo.org`)"
  traefik.http.routers.discourse.entrypoints: "websecure"
  traefik.http.routers.discourse.tls: "true"
  traefik.http.routers.discourse.tls.certresolver: "letsencrypt"

  ## Service: internal port 80 (TLS terminates at Traefik)
  traefik.http.services.discourse.loadbalancer.server.port: "80"
  traefik.http.services.discourse.loadbalancer.server.scheme: "http"

run:
  - exec: echo "Beginning of custom commands"
  - exec: echo "End of custom commands"
